# Apicurio Storage Service Integration Tests

This document describes the integration tests for the Apicurio-based storage service implementation in Fennec Model Atlas.

## Overview

The `EObjectApicurioStorageServiceTest` class contains comprehensive integration tests for the `EObjectApicurioStorageService`, which provides persistent storage for EMF EObjects using Apicurio Registry as the backend.

These tests use **Testcontainers** to spin up a real Apicurio Registry instance in a Docker container, allowing for true integration testing against a live service.

## Architecture

```
┌─────────────────────────────────────────┐
│   JUnit 5 OSGi Integration Test         │
│   (EObjectApicurioStorageServiceTest)   │
└────────────────┬────────────────────────┘
                 │
                 │ @InjectService
                 ↓
┌─────────────────────────────────────────┐
│   EObjectApicurioStorageService         │
│   (OSGi Service)                        │
└────────────────┬────────────────────────┘
                 │
                 │ HTTP REST API
                 ↓
┌─────────────────────────────────────────┐
│   Apicurio Registry                     │
│   (Testcontainer)                       │
│   - Image: apicurio/apicurio-registry   │
│   - Port: 8080 (mapped)                 │
└─────────────────────────────────────────┘
```

## Test Setup

### Container Configuration

Each test starts a fresh Apicurio Registry container with:

- **Docker Image**: `apicurio/apicurio-registry:latest-release`
- **Exposed Port**: `8080` (mapped to random host port)
- **Environment Variables**:
  - `APICURIO_REST_DELETION_ARTIFACT_ENABLED=true` - Enables artifact deletion API

```java
try (GenericContainer<?> container = new GenericContainer<>(APICURIO_DOCKER_IMAGE)) {
    container.withEnv(APICURIO_ENV_DELETION_ARTIFACT, "true")
             .withExposedPorts(APICURIO_EXPOSED_PORT);
    container.start();

    int mappedPort = container.getMappedPort(8080);
    // Configure OSGi service with container URL
}
```

### OSGi Service Configuration

After container startup, the test configures the OSGi service via ConfigAdmin:

```java
Dictionary<String, Object> serviceProperties = new Hashtable<>();
serviceProperties.put("base.url", String.format("http://localhost:%d/apis/registry/v3/", mappedPort));
configuration.update(serviceProperties);

Thread.sleep(3000); // Allow service activation time
```

### Test Annotations

Tests use several OSGi testing annotations:

- `@ExtendWith(BundleContextExtension.class)` - Provides OSGi BundleContext
- `@ExtendWith(ServiceExtension.class)` - Enables service injection
- `@ExtendWith(ConfigurationExtension.class)` - Enables configuration injection
- `@RegistryConfiguration` - Configures shared Lucene registry service
- `@InjectConfiguration` - Injects ConfigAdmin configuration
- `@InjectService` - Injects OSGi services with filters

## Test Coverage

### Core Functionality Tests

#### 1. Service Activation (`testServiceActivation`)
- **Purpose**: Verifies the storage service activates correctly with Apicurio backend
- **Assertions**:
  - Service becomes available after configuration
  - Backend type is `APICURIO`

#### 2. Store and Retrieve (`testStoreAndRetrieveEPackageInJson`)
- **Purpose**: Tests basic store/retrieve cycle with JSON serialization
- **Operations**:
  - Creates an EPackage with metadata
  - Stores to Apicurio with custom ID
  - Retrieves and validates content
  - Verifies metadata preservation
  - Cleans up by deleting artifact
- **Format**: JSON (`.json` extension)

#### 3. Existence Check (`testExists`)
- **Purpose**: Tests the `exists()` method
- **Scenarios**:
  - Non-existent object returns `false`
  - Stored object returns `true`
  - Deleted object returns `false`
  - Null/empty ID returns `false`

#### 4. Delete Object (`testDeleteObject`)
- **Purpose**: Validates object deletion
- **Assertions**:
  - Delete operation succeeds
  - Retrieval after deletion returns `null`

#### 5. List Object IDs (`testListObjectIds`)
- **Purpose**: Tests listing all stored objects
- **Operations**:
  - Stores 3 EPackages
  - Lists all IDs
  - Verifies count and content
  - Cleans up all objects

#### 6. Auto-Generated ID (`testAutoGeneratedId`)
- **Purpose**: Tests storing without explicit ID
- **Behavior**:
  - Pass `null` as object ID
  - Service generates unique ID
  - Object retrievable with generated ID

### Metadata Tests

#### 7. Custom File Extension (`testCustomFileExtension`)
- **Purpose**: Tests different serialization formats
- **Scenarios**:
  - Custom extension (`.json`)
  - Default extension (`.xmi`)
  - Both formats can be stored and retrieved

#### 8. Content Type (`testContentType`)
- **Purpose**: Tests content type handling
- **Configuration**:
  - File extension: `.ecore`
  - Content type: `application/xml`
- **Validates**: Format negotiation works correctly

#### 9. Update Metadata (`testUpdateMetadata`)
- **Purpose**: Tests metadata modification without changing content
- **Operations**:
  - Store object with initial metadata
  - Update metadata (user, channel, hash, custom properties)
  - Verify immutable fields preserved (upload user)
  - Verify object unchanged

#### 10. Update Status (`testUpdateStatus`)
- **Purpose**: Tests object status workflow
- **Status Flow**: `DRAFT` → `APPROVED` → `DEPLOYED`
- **Tracking**:
  - Last change user recorded
  - Last change time recorded
  - Previous values preserved when user is `null`

#### 11. Get Object Count (`testGetObjectCount`)
- **Purpose**: Tests object counting
- **Operations**:
  - Initial count is 0
  - Count increases with stores
  - Count decreases with deletes
  - Count matches `listObjectIds()` size

### Error Handling Tests

#### 12. Update Metadata Error Handling (`testUpdateMetadataErrorHandling`)
- **Purpose**: Tests error scenarios for metadata updates
- **Scenario**: Update non-existent object
- **Expected**: Returns `false` without throwing exception

#### 13. Update Status Error Handling (`testUpdateStatusErrorHandling`)
- **Purpose**: Tests error scenarios for status updates
- **Scenario**: Update non-existent object
- **Expected**: Returns `false` without throwing exception

### Role Management Tests

#### 14. Role Functionality (`testRoleFunctionality`)
- **Purpose**: Tests automatic role assignment based on storage configuration
- **Configuration**: `storage.role=custom-role`
- **Assertions**:
  - Role automatically set during `storeObject()`
  - Role applied during `updateMetadata()`
  - Storage role overrides metadata role
  - Original metadata not modified (copy-based)

#### 15. Different Storage Roles (`testDifferentStorageRoles`)
- **Purpose**: Tests multiple storage services with different roles
- **Configuration**: `storage.role=approved`
- **Validates**: Independent role configuration per service instance

#### 16. Service Activation with Default Role (`testServiceActivationWithDefaultRole`)
- **Purpose**: Tests default role behavior
- **Configuration**: No `storage.role` specified
- **Expected**: Defaults to `"draft"` role

### Integration Tests

#### 17. Storage-Registry Integration (`testStorageRegistryIntegration`)
- **Purpose**: Tests interaction between storage and registry services
- **Operations**:
  - Store objects with different statuses
  - Query registry by status
  - Verify registry finds stored objects
  - Update status and verify registry updates
  - Test `DRAFT`, `APPROVED`, and `REJECTED` statuses

## Running the Tests

### From Command Line

```bash
# Run all tests
./gradlew :org.eclipse.fennec.model.atlas.management.apicurio.tests:test

# Run specific test
./gradlew :org.eclipse.fennec.model.atlas.management.apicurio.tests:test --tests EObjectApicurioStorageServiceTest.testStoreAndRetrieveEPackageInJson
```

### From IDE

1. Ensure Docker is running
2. Run the test.bndrun configuration
3. Individual tests can be run via JUnit 5 runner

### Prerequisites

- Docker installed and running
- Internet connection (first run downloads Apicurio image)
- At least 2GB available RAM for containers
- Ports available for Docker port mapping

## Test Execution Flow

```
1. Test method starts
   ↓
2. @RegistryConfiguration activates shared Lucene registry
   ↓
3. Testcontainer creates Apicurio Registry container
   ↓
4. Container starts (may take 5-10 seconds)
   ↓
5. Test retrieves mapped port
   ↓
6. ConfigAdmin updates service configuration with container URL
   ↓
7. EObjectApicurioStorageService activates
   ↓
8. Test waits for service (timeout: 5 seconds)
   ↓
9. Test performs operations (store, retrieve, etc.)
   ↓
10. Test cleanup: delete artifacts
   ↓
11. Try-with-resources stops container
   ↓
12. Test completes
```

## Configuration Properties

### Apicurio Storage Service

| Property | Description | Example |
|----------|-------------|---------|
| `base.url` | Apicurio Registry API base URL | `http://localhost:8080/apis/registry/v3/` |
| `storage.role` | Role assigned to stored objects | `draft`, `approved`, `custom-role` |
| `workspace.folder` | Local workspace directory | `/tmp/test-workspace` |

### Registry Service (from @RegistryConfiguration)

| Property | Description | Default |
|----------|-------------|---------|
| `registry.workspace.folder` | Lucene index location | `{tempDir}/shared-registry` |
| `storage.backend.tracking` | Track storage services | `true` |
| `initial.index.capacity` | Initial index size | `1000` |
| `enable.debug.logging` | Debug logging | `true` |

## Common Test Patterns

### 1. Basic Store/Retrieve Pattern

```java
// Create object
EPackage pkg = EcoreFactory.eINSTANCE.createEPackage();
pkg.setName("TestPackage");

// Create metadata
ObjectMetadata metadata = ManagementFactory.eINSTANCE.createObjectMetadata();
metadata.setUploadUser("testUser");
metadata.setObjectRef(pkg);

// Store
Promise<String> storePromise = storageService.storeObject("my-id", pkg, metadata);
String id = storePromise.getValue();

// Retrieve
Promise<EObject> retrievePromise = storageService.retrieveObject(id);
EPackage retrieved = (EPackage) retrievePromise.getValue();

// Cleanup
storageService.deleteObject(id).getValue();
```

### 2. Status Update Pattern

```java
// Store with initial status
metadata.setStatus(ObjectStatus.DRAFT);
storageService.storeObject(id, obj, metadata).getValue();

// Update status
storageService.updateStatus(id, ObjectStatus.APPROVED, "approverUser").getValue();

// Verify
ObjectMetadata updated = storageService.retrieveMetadata(id).getValue();
assertEquals(ObjectStatus.APPROVED, updated.getStatus());
```

### 3. Service Filter Pattern

```java
@InjectService(cardinality = 0, filter = "(storage.backend=apicurio)")
ServiceAware<EObjectStorageService> serviceAware
```

Filters:
- `(storage.backend=apicurio)` - Apicurio storage service
- `(registry.type=shared)` - Shared registry service
- `(storage.role=approved)` - Storage with specific role

## Troubleshooting

### Container Won't Start
- Check Docker: `docker ps`
- Verify image: `docker pull apicurio/apicurio-registry:latest-release`
- Check Docker logs: `docker logs <container-id>`

### Service Timeout
- Increase wait time: `waitForService(10000L)`
- Check bundle resolution: verify all `-runbundles` present
- Review OSGi logs for service activation errors

### Test Hangs
- Container may be slow to start (normal: 5-10s)
- Check system resources (CPU, memory)
- Verify no port conflicts

### Cleanup Issues
- Apicurio deletion must be enabled: `APICURIO_REST_DELETION_ARTIFACT_ENABLED=true`
- Container automatically cleaned up by try-with-resources
- Temporary directories cleaned by `@TempDir`

## Performance Considerations

- **Container Startup**: ~5-10 seconds per test
- **Service Activation**: ~3 seconds (configured wait time)
- **Total Test Time**: ~10-15 seconds per test method
- **Parallel Execution**: Not recommended (Docker resource contention)

## Dependencies

See `test.bndrun` for complete dependency list. Key dependencies:

- `org.eclipse.daanse.tooling.testcontainers.core` - OSGified Testcontainers
- `org.osgi.test.junit5` - OSGi testing framework
- `org.eclipse.fennec.model.atlas.management.apicurio` - Implementation bundle
- `org.eclipse.fennec.model.atlas.management.lucene` - Lucene registry for integration tests

## Future Enhancements

- Container reuse across tests (reduce startup overhead)
- Test data builders for complex scenarios
- Performance benchmarking tests
- Multi-version Apicurio compatibility tests
- Concurrent access tests
